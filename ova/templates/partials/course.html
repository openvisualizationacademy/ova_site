{% load static wagtailcore_tags wagtailimages_tags wagtailmarkdown %}

<section class="course-page grid">

  <!-- Screen reader announcements -->
  <div id="completed" hidden>Completed</div>

  {% with course_tags=course.tags.all course_instructors=course.course_instructors.all %}
    <div class="media" data-tags="{% for tag in course_tags %}{{ tag }}{% if not forloop.last %},{% endif %}{% endfor %}">
      {% if course.image %}
        {% image course.image original as img %}
        <img src="{{ img.url }}" alt="">
      {% else %}
        {% comment %} White pixel {% endcomment %}
        <img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAQAAAC1HAwCAAAAC0lEQVR42mP8/x8AAwMCAO+ip1sAAAAASUVORK5CYII=">
      {% endif %}
    </div>

    <div class="course">
      <div class="card">
        <div class="primary">
          <span class="kicker">Course<span class="screen-reader">:</span></span>
          <h1>{{ course.title }}</h1>
          <p class="authors small">
            <span class="screen-reader">Author{{ course_instructors|pluralize }}:</span>

            {% for iteration in course_instructors %}
              <span class="author">
                {% if iteration.instructor.image %}
                  {% image iteration.instructor.image fill-48x48 as img %}
                  <img src="{{ img.url }}" alt="">
                {% endif %}
                {{ iteration.instructor.name }}
              </span>
            {% endfor %}
          </p>
        </div>
        <div class="secondary small">
          {% if course_tags %}
            <p class="tags">
              {% for tag in course_tags %}
                <span class="tag" data-tag="{{ tag }}">{{ tag }}</span>
              {% endfor %}
            </p>
          {% endif %}
          {% with duration=course.formatted_duration %}
            {% if duration %}
              <p class="duration">
                <span class="screen-reader">Duration: </span>
                {{ course.formatted_duration }}
              </p>
            {% endif %}
          {% endwith %}
        </div>
      </div>
    </div>
  {% endwith %}

  {% if user.is_authenticated %}

    {% comment %} Calculate and display course progress {% endcomment %}
    {% with percent=course_percent_complete|default:0 %}

      {% comment %} Consider using scoped variables instead of global ones {% endcomment %}
      <script>

        /* Percent of segment complete (0-100) */
        window.segmentId = {{ segment.id }};
      </script>

      <div class="tracker">
        <div class="progress {% if percent == 100 %}completed{% endif %}">
          <label>
            <span class="screen-reader">Course progress</span> 
            <div class="donut" style="--percent: {{ percent }}%">
              <progress value="{{ percent }}" min="0" max="100" class="screen-reader">{{ percent }}%</progress>
              {% if percent == 100 %}
                <svg width="24" height="24" data-icon="check" aria-hidden="true"></svg>
              {% endif %}
            </div>
          </label>
          <p>
            <strong class="percent">{{ percent }}%</strong>
            of course completed
          </p>
        </div>
        {% include 'partials/certificate.html' with percent=percent %}
      </div>
    {% endwith %}

  {% else %}

    {% include 'partials/sign-in-warning.html' %}

  {% endif %}

  <section class="overview grid">
    <p class="content-updated">
      {% if course.updated_on %}
        <small>
          Content updated in
          <time datetime="{{ course.updated_on|date:'Y-m' }}">
            {{ course.updated_on|date:"F Y" }}
          </time>
        </small>
      {% endif %}
    </p>

    {% if course.content %}
      {% include 'partials/overview.html' %}
    {% endif %}
  </section>

  <div class="sticky-wrapper grid">
    <aside class="chapters">
      <header>
        <h2>Chapters</h2>

        {% include 'partials/compact-view.html' %}

        {% comment %}
          <div class="arrows">
            <a href="#" class="button tertiary">
              <svg width="24" height="24" data-icon="chevron-left" aria-hidden="true"></svg>
              <span class="screen-reader">Previous</span>
            </a>
            <a href="#" class="button tertiary">
              <svg width="24" height="24" data-icon="chevron-right" aria-hidden="true"></svg>
              <span class="screen-reader">Next</span>
            </a>
          </div>
        {% endcomment %}
      </header>

      {% if chapter_data %}
        {% include 'partials/chapter-list.html' %}
      {% endif %}
    </aside>

    {% comment %} If segment is completed, add `completed` class so [quiz] tag turns green {% endcomment %}
    <section class="content">

      <h2 id="main" tabindex="-1" {% if segment_progress == 100 %}class="completed"{% endif %}>
        <span class="number kicker">
          {{ chapter_number }}.{{ segment_number }}
        </span>
        <span>
          {% if quiz %}
            <span class="quiz-badge kicker">Quiz</span>
            {{ quiz.title|default:"Test your knowledge" }}
          {% else %}
            {{ segment.title }}
          {% endif %}

          {% if segment_progress == 100 %}
            <svg width="24" height="24" data-icon="check-circle" aria-label="Completed"></svg>
          {% else %}
            {% comment %} Checkmark to be injected with JS as soon as video is fully watched {% endcomment %}
            <template class="complete-checkmark-title">
              <svg width="24" height="24" data-icon="check-circle" aria-label="Completed"></svg>
            </template>
          {% endif %}
        </span>
      </h2>

      {% if segment.video_url %}
        {% include 'partials/video.html' with id=vimeo_id %}
      {% endif %}

      {% if segment.content or chapter.content or quiz %}
        <section class="content-written">
          <h3 class="screen-reader">Content</h3>

          {% if segment.content %}
          <div class="content-written-segment">
            {% for block in segment.content %}
              {% if block.block_type == "rich_text" %}
                {{ block.value|richtext }}
              {% elif block.block_type == "markdown" %}
                {{ block.value|markdown }}
              {% endif %}
            {% endfor %}
          </div>
          {% endif %}

          {% if chapter.content and not quiz %}
          <div class="content-written-chapter">
            {% for block in chapter.content %}
              {% if block.block_type == "rich_text" %}
                {{ block.value|richtext }}
              {% elif block.block_type == "markdown" %}
                {{ block.value|markdown }}
              {% endif %}
            {% endfor %}
          </div>
          {% endif %}

          <!-- TEMP: Check if page is “quiz” (temporary fix) -->
          {% if quiz %}
            {% include 'partials/quiz.html' %}
          {% endif %}
        </section>
      {% endif %}

      <!-- TODO: Hide materials if current segment is a “quiz” -->
      {% if not quiz %}
        {% if segment_materials or chapter_materials or course_materials %}
          {% include 'partials/materials.html' %}
        {% endif %}
      {% endif %}

      <!-- TODO: Consider need to check segment before adding arrows -->
      {% if segment %}
        {% include 'partials/chapter-arrows.html' %}
      {% endif %}

    </section>
  </div>
</section>