{% load get_item %}

{% if submitted %}
  <div class="quiz-score">
    <p>
      <strong>You scored {{ score }}%</strong><br>
      <small>In last submission</small>
    </p>
  </div>
{% endif %}

{% comment %} Donâ€™t use form if all questions are already correctly submitted {% endcomment %}
{% if score is not 100 %}
  <form class="quiz" method="post">
    {% csrf_token %}
{% else %}
  <div class="quiz">
{% endif %}

  <!-- Screen reader announcements -->
  <div id="correct" hidden>Correct</div>
  <div id="incorrect" hidden>Wrong</div>

  {% for question in quiz.questions.all %}
    {% with qid=question.id %}
      {% with submitted_choice=answers|get_item:qid %}
        {% with is_correct=answer_results|get_item:qid %}

          {% comment %} Using both attribute & class as the latter is to retain style after attribute is removed on submit {% endcomment %}
          <fieldset {% if submitted and is_correct %}disabled class="disabled"{% endif %}>
            <legend>
              <span class="count kicker">
                <span aria-hidden="true">Q{{ forloop.counter }}</span>
                <span class="screen-reader">
                  Question {{ forloop.counter }}
                </span>
              </span>
              {{ question }}
            </legend>

            {% if submitted and answers %}
              {% for choice in question.choices.all %}
                <label class="choice">
                  <input
                    type="radio"
                    name="{{ question.id }}"
                    value="{{ choice.id }}"
                    class="screen-reader"

                    {% if submitted_choice == choice.id %}
                      {% if is_correct %}
                        aria-describedby="correct"
                        checked
                      {% else %}
                        aria-describedby="incorrect"
                        disabled
                      {% endif %}
                    {% endif %}
                  >
                  <span>{{ choice }}</span>

                  {% if submitted_choice == choice.id %}
                    {% if is_correct %}
                      <svg width="24" height="24" data-icon="check" aria-hidden="true"></svg>
                    {% else %}
                      <svg width="24" height="24" data-icon="x-mark" aria-hidden="true"></svg>
                    {% endif %}
                  {% endif %}
                </label>
              {% endfor %}
            {% else %}
              {% for choice in question.choices.all %}
                <label class="choice">
                  <input
                    type="radio"
                    name="{{ question.id }}"
                    value="{{ choice.id }}"
                    class="screen-reader"
                    {% if forloop.first %}required{% endif %}
                  >
                  <span>{{ choice }}</span>
                </label>
              {% endfor %}
            {% endif %}

          </fieldset>

        {% endwith %}
      {% endwith %}
    {% endwith %}
  {% endfor %}

  {% comment %} Hide submit button if all questions were already correctly submitted {% endcomment %}
  {% if score is not 100 %}
    <button class="button primary">Submit answers</button>
  {% endif %}

{% if score is not 100 %}
  </form>
{% else %}
  </div>
{% endif %}

