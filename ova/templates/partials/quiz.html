{% load get_item %}

<form class="quiz" method="post">
  {% csrf_token %}

  <!-- Screen reader announcements -->
  <div id="correct" hidden>Correct</div>
  <div id="incorrect" hidden>Wrong</div>

  {% for question in quiz.questions.all %}
    <fieldset>
      <legend>
        <span class="count kicker">
          <span aria-hidden="true">Q{{ forloop.counter }}</span>
          <span class="screen-reader">Question {{ forloop.counter }}</span>
        </span>
        {{ question }}
      </legend>

      {# We guard before evaluating answers, so template never crashes #}
      {% if submitted and answers %}
          {% with submitted_choice=answers|get_item:question.id %}

              {% for choice in question.choices.all %}
                  <label class="choice">
                    <input
                      type="radio"
                      name="{{ question.id }}"
                      value="{{ choice.id }}"
                      class="screen-reader"
                      {% if forloop.first %}required{% endif %}

                      {# If this choice was selected, mark checked #}
                      {% if submitted_choice == choice.id|stringformat:"s" %}
                        checked

                        {# Add semantic correctness for CSS highlighting #}
                        {% if choice.is_correct %}
                          aria-describedby="correct"
                        {% else %}
                          aria-describedby="incorrect"
                        {% endif %}
                      {% endif %}
                    >
                    <span>{{ choice }}</span>
                  </label>
              {% endfor %}

          {% endwith %}

      {% else %}
          {# GET request or missing answers â†’ render normal choices #}
          {% for choice in question.choices.all %}
              <label class="choice">
                <input
                  type="radio"
                  name="{{ question.id }}"
                  value="{{ choice.id }}"
                  class="screen-reader"
                  {% if forloop.first %}required{% endif %}

                  {% comment %} TEMP: Display correct alternatives so instructors can review answers {% endcomment %}
                  {% if choice.is_correct %}
                    aria-describedby="correct"
                  {% endif %}
                >
                <span>{{ choice }}</span>

                {% comment %} TEMP: Display correct checkmarks so instructors can review answers {% endcomment %}
                {% if choice.is_correct %}
                  <svg width="24" height="24" data-icon="check" aria-hidden="true"></svg>
                {% endif %}
              </label>
          {% endfor %}
      {% endif %}

    </fieldset>
  {% endfor %}

  <button class="button primary">Submit answers</button>

  {% if submitted %}
    <p class="quiz-score">Score: {{ score }}%</p>
  {% endif %}
</form>
