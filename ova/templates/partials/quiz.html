{% load get_item %}

<form class="quiz" method="post">
  {% csrf_token %}

  <!-- Screen reader announcements -->
  <div id="correct" hidden>Correct</div>
  <div id="incorrect" hidden>Wrong</div>

  {% for question in quiz.questions.all %}
    <fieldset>
      <legend>
        <span class="count kicker">
          <span aria-hidden="true">Q{{ forloop.counter }}</span>
          <span class="screen-reader">
            Question {{ forloop.counter }}
          </span>
        </span>
        {{ question }}
      </legend>
      {% if submitted and answers %}
        {% with qid=question.id|stringformat:"s" %}
          {% with submitted_choice=answers|get_item:qid %}
            {% with is_correct=answer_results|get_item:qid %}

              {% for choice in question.choices.all %}
                <label
                    class="choice{% if submitted_choice == choice.id %} {% if is_correct %}correct{% else %}incorrect{% endif %}{% endif %}">
                  <input
                      type="radio"
                      name="{{ question.id }}"
                      value="{{ choice.id }}"
                      class="screen-reader"

                      {% if submitted_choice == choice.id %}
                        checked
                        {% if is_correct %}
                      aria-describedby="correct"
                      data-locked="true"
                        {% else %}
                      aria-describedby="incorrect"
                        {% endif %}
                      {% endif %}
                  >
                  <span>{{ choice }}</span>
                </label>
              {% endfor %}

            {% endwith %}
          {% endwith %}
        {% endwith %}
      {% else %}
        {% for choice in question.choices.all %}
          <label class="choice">
            <input
                type="radio"
                name="{{ question.id }}"
                value="{{ choice.id }}"
                class="screen-reader"
                {% if forloop.first %}required{% endif %}
            >
            <span>{{ choice }}</span>
          </label>
        {% endfor %}
      {% endif %}

    </fieldset>
  {% endfor %}

  <button class="button primary">Submit answers</button>

  {% if submitted %}
    <p class="quiz-score">
      Score: {{ score }}%
    </p>
  {% endif %}
</form>
