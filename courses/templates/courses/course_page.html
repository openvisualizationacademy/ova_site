{% extends "base.html" %}
{% load static wagtailcore_tags wagtailimages_tags wagtailmarkdown %}

{% block content %}

<section class="course-page grid">

  <div class="media"></div>

  <div class="course" data-tags="{% for tag in course.tags.all %}{{ tag }}{% if not forloop.last %},{% endif %}{% endfor %}">
    <div class="card">
      <div class="primary">
        <span class="kicker">Course<span class="screen-reader">:</span></span>
        <h1>{{ page.title }}</h1>
        <p class="authors">
          <span class="screen-reader">Author{{ self.course_instructors.all|pluralize }}:</span>

          {% for iteration in self.course_instructors.all %}
            <span class="author">
              {% if iteration.instructor.image %}
                {% image iteration.instructor.image fill-48x48 as img %}
                <img src="{{ img.url }}" alt="">
              {% endif %}
              {{ iteration.instructor.name }}
            </span>
          {% endfor %}
        </p>
      </div>
      <div class="secondary">
        {% with tags=self.tags.all %}
          {% if tags %}
            <p class="tags">
              {% for tag in tags %}
                <span class="tag" data-tag="{{ tag }}">{% comment %}{{ tag }}{% endcomment %}</span>
              {% endfor %}
            </p>
          {% endif %}
        {% endwith %}
        <p class="duration">
          <span class="screen-reader">Duration: </span>
          {% with rounded=self.duration|default:3|floatformat:0 %}
            {{ rounded }}<span aria-hidden="true">h</span>
            <span class="screen-reader">hour{{ rounded|pluralize }}</span>
          {% endwith %}
        </p>
      </div>
    </div>
  </div>

  {% if user.is_authenticated %}

    <!-- TODO: Calculate and display course progress -->
    {% with percentage=37 %}
      <div class="tracker">
        <div class="progress {% if percentage == 100 %}completed{% endif %}">
          <label>
            <span class="screen-reader">Course progress</span> 
            <div class="donut" style="--percentage: {{ percentage }}%">
              <progress value="{{ percentage }}" min="0" max="100" class="screen-reader">{{ percentage }}%</progress>
              {% if percentage == 100 %}
                <svg width="24" height="24" data-icon="check" aria-hidden="true"></svg>
              {% endif %}
            </div>
          </label>
          <p>
            <strong class="percentage">{{ percentage }}%</strong>
            of course completed
          </p>
        </div>
        <div class="certificate">
          {% if percentage == 100 %}
            <a href="#" class="button tertiary">
              <svg width="24" height="24" data-icon="download" aria-hidden="true"></svg>
              <span>
                <span class="screen-reader">Download</span>
                Certificate
              </span>
            </a>
          {% else %}
            <small>Complete to earn PDF certificate</small>
          {% endif %}
        </div>
      </div>
    {% endwith %}

  {% else %}

    <!-- TODO: Remember whether user deactivated warning (and add class conditionally) -->
    <p id="sign-in-description" class="warning" onclick="this.classList.remove('warning')">
      To get a <strong>certificate</strong> of completion, sign in to track your progress
    </p>

  {% endif %}

  <section class="overview grid">
    <p class="content-updated">
      <!-- TODO: Make this field dynamic -->
      <small>Content updated in <time datetime="2025-09">September 2025</time></small>
    </p>

    {% if page.content %}
    <!-- TODO: Remember whether user collapsed overview for course (and add open attribute conditionally) -->
    <details open>
      <summary class="kicker">
        <span>Overview</span>
      </summary>
      <div>
        {% for block in page.content %}
          {% if block.block_type == "markdown" %}
            {{ block.value|markdown }}
          {% elif block.block_type == "rich_text" %}
            {{ block.value|richtext }}
          {% endif %}
        {% endfor %}
      </div>
    </details>
    {% endif %}
  </section>

  <div class="sticky-wrapper grid">

    <section class="chapters">
      <header>
        <h2>Chapters</h2>

        {% comment %}
        <div class="arrows">
          <a href="#" class="button tertiary">
            <svg width="24" height="24" data-icon="chevron-left" aria-hidden="true"></svg>
            <span class="screen-reader">Previous</span>
          </a>
          <a href="#" class="button tertiary">
            <svg width="24" height="24" data-icon="chevron-right" aria-hidden="true"></svg>
            <span class="screen-reader">Next</span>
          </a>
        </div>
        {% endcomment %}
      </header>

      {% if page.get_children.live %}
        <ol>
          {% for chapter in page.get_children.live.specific %}
            <li>
              <a href="{{ chapter.url }}" {% if request.path == chapter.url %}class="active"{% endif %}>
                {{ chapter.title }}
              </a>
              {% if chapter.get_children.live %}
                <ol>
                  {% for segment in chapter.get_children.live.specific %}
                  <li>
                    <a href="{{ segment.url }}" {% if request.path == chapter.url %}class="active"{% endif %}>
                      {{ segment.title }}
                    </a>
                  </li>
                  {% endfor %}

                  <!-- TEMP: Add a fake quiz at the end of each chapter -->
                  <li>
                    <a href="javascript:void(0)">
                      <span class="quiz-badge kicker">Quiz</span>
                      Test your knowledge
                    </a>
                  </li>
                </ol>
              {% endif %}
            </li>
          {% endfor %}
        </ol>
      {% endif %}

      <!-- TEMP: Randomly set chapters or segments as completed to test style -->
      <script>
        (function() {
          const courseParts = document.querySelectorAll(".chapters ol a");
          courseParts.forEach((part, index) => {
            const chance = index === 0 || Math.random() < .3;
            part.classList.toggle("completed", chance);
          });

        })();
      </script>

    </section>

    <section class="content">
      <h2>
        <!-- TODO: Make segment title dynamic -->
        Introduction
      </h2>

      <!-- TODO: Make Vimeo embed dynamic -->
      <div class="vimeo-embed">
        <div style="padding:56.25% 0 0 0;position:relative;">
          <iframe src="https://player.vimeo.com/video/1138278637?badge=0&amp;autopause=0&amp;player_id=0&amp;app_id=58479" frameborder="0" allow="autoplay; fullscreen; picture-in-picture; clipboard-write; encrypted-media; web-share" referrerpolicy="strict-origin-when-cross-origin" style="position:absolute;top:0;left:0;width:100%;height:100%;" title="1. Introduction"></iframe>
        </div>
        <script src="https://player.vimeo.com/api/player.js"></script>
      </div>
      <!-- <div style="padding:56.25% 0 0 0;position:relative;">
        <iframe src="https://player.vimeo.com/video/171945580?badge=0&amp;autopause=0&amp;player_id=0&amp;app_id=58479" frameborder="0" allow="autoplay; fullscreen; picture-in-picture; clipboard-write; encrypted-media; web-share" referrerpolicy="strict-origin-when-cross-origin" style="position:absolute;top:0;left:0;width:100%;height:100%;" title="An introduction to data visualization"></iframe>
      </div>
      <script src="https://player.vimeo.com/api/player.js"></script> -->

      {% if page.materials.exists %}
        <h2>Course Materials</h2>
        <ul>
          {% for material in page.materials.all %}
            <li><a href="{{ material.file }}" download>{{ material.title }}</a></li>
          {% endfor %}
        </ul>
      {% endif %}

      <div class="arrows">
        <a href="#" class="button secondary">
          <svg width="24" height="24" data-icon="chevron-left" aria-hidden="true"></svg>
          <span>Back</span>
        </a>
        <a href="#" class="button secondary">
          <span>Next</span>
          <svg width="24" height="24" data-icon="chevron-right" aria-hidden="true"></svg>
        </a>
      </div>

    </section>

  </div>

</section>
  
{% endblock %}
